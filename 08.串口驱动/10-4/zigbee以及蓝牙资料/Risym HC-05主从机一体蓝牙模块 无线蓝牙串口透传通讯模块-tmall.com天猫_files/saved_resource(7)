KISSY.add("detail-model/combo",function(e,t){function n(t){n.superclass.constructor.apply(this,arguments);var o=this;_CTK6da3(7,"model.combo.init","app.init");o.addAttr("comboData",{});o.addAttr("buyerLoc",{load:function(e){e("330100")}});o.addAttr("minicart",{load:function(t){e.use("mui/minicart",function(e,n){t(n)})}});o.addAttr("master",{load:function(t){o.onLoad(["comboData","products"],function(n,o){var a=null;e.each(n&&n.items,function(e,t){if(e.master){a=o[t]}});t(a)})}});o.addAttr("products",{load:function(t){o.onLoad(["comboData"],function(n){var a=n&&n.items,i={};if(!a){return t(null)}function r(t,a){if(n.type!==1){t.isSelected=true}if(n.reservePrice!==undefined){return a(t)}o.onLoad(["buyerLoc","urlMap"],function(o,i){if(!i.apiTmallComboItem||!t||!(t.hasSku||t.hasService)){return a(t)}var r="",c;try{c=/cna=([^;]+)/.exec(document.cookie);if(c){r=decodeURIComponent(c[1])}}catch(u){}var m,d;e.each(n.items,function(e){if(e.master){m=e.itemId;d=e.sellerId;return false}});e.use("ajax",function(e,c){c({url:i.apiTmallComboItem,data:{cna:r,refer:encodeURIComponent(document.referrer),itemId:t.itemId,areaId:o,comboId:n.id,mainItemId:m||"",type:n.type,sellerId:t.sellerId,householdService:t.householdService,manufactureCity:encodeURI(t.manufactureCity),manufactureVolume:t.manufactureVolume},dataType:"jsonp",success:function(n){if(n.success){e.each(n.skuMap,function(e){e.price=(e.price/100).toFixed(2)});e.mix(t,n)}a(t)},error:function(){a(t)}})})})}e.use("detail-model/productCombo",function(e,n){e.each(a,function(t,a){i[a]=new n;i[a].onLogin=o.onLogin;i[a].addAttr("itemData",{load:function(e){r(t,e)}});i[a].addAttr("amountMultiple",{load:function(e){o.onChange("amount",e)}});e.each(["buyerLoc","token","state"],function(e){i[a].addAttr(e,{load:function(t){o.onChange(e,t)}})})});t(i);o.onChange(["comboData"],function(t){e.each(t.items,function(e,t){if(!i[t]){return}r(e,function(e){i[t].set("itemData",e)})})})})})}});o.addAttr("selectedProducts",{load:function(t){o.onLoad(["products","comboData"],function(n,o){e.each(n,function(a){if(o.type!=1){return t(n)}a.onChange("itemEnable",function(o){var a={};e.each(n,function(e,t){if(e.get("itemEnable")){a[t]=e}});t(a)})})})}});o.addAttr("amount",{validator:function(e){return!isNaN(e=parseInt(e,10))&&e>0},setter:function(e){return parseInt(e,10)},load:function(e){e(1)}});o.addAttr("originalPrice",{load:function(t){o.onLoad("products",function(n){e.each(n,function(o,a){o.onChange(["originalPrice","servicePrice","amount","itemEnable"],function(o,a,i,r){var c={max:0,min:0},u=true;e.each(n,function(e,t){if(e.get("itemEnable")){var n=e.get("originalPrice"),o=e.get("servicePrice"),a=e.get("amount")||1;if(n!=null){c.max+=n.max*a;c.min+=n.min*a;u=false}if(o!=null){c.max+=o.max*a;c.min+=o.min*a}}});if(u){c=null}else{c.min=c.min.toFixed(2);c.max=c.max.toFixed(2);c.str=c.min;if(c.min!=c.max){c.str+="-"+c.max}}t(c)})})})}});o.addAttr("comboPrice",{load:function(t){o.onLoad(["comboData","amount","products"],function(n,o,a){if(n.reservePrice){return t({min:(n.reservePrice/100).toFixed(2),max:(n.reservePrice/100).toFixed(2),str:(n.reservePrice/100).toFixed(2)})}e.each(a,function(n,o){n.onChange(["comboPrice","servicePrice","amount","itemEnable"],function(n,o,i,r){var c={max:0,min:0},u=true;e.each(a,function(e,t){if(e.get("itemEnable")){var n=e.get("comboPrice"),o=e.get("servicePrice"),a=e.get("amount")||1;if(n!=null){c.max+=n.max*a;c.min+=n.min*a;u=false}if(o!=null){c.max+=o.max*a;c.min+=o.min*a}}});if(u){c=null}else{c.min=c.min.toFixed(2);c.max=c.max.toFixed(2);c.str=c.min;if(c.min!=c.max){c.str+="-"+c.max}}t(c)})})})}});o.addAttr("totalPrice",{load:function(e){o.onChange(["comboPrice","amount"],function(t,n){var o={min:(t.min*1*n).toFixed(2),max:(t.max*1*n).toFixed(2)};o.str=o.min;if(o.min!=o.max){o.str+="-"+o.max}e(o)})}});o.addAttr("saveMoney",{load:function(t){o.onLoad("comboData",function(n){if(n.type==1){o.onLoad("products",function(n){e.each(n,function(o,a){o.onChange(["saveMoney","amount","itemEnable"],function(o,a,i){var r={max:0,min:0},c=true;e.each(n,function(e,t){if(e.get("itemEnable")){var n=e.get("saveMoney"),o=e.get("amount")||1;if(n!=null){r.max+=n.max*o;r.min+=n.min*o;c=false}}});if(c){r=null}else{r.min=r.min.toFixed(2);r.max=r.max.toFixed(2);r.str=r.min;if(r.min!=r.max){r.str+="-"+r.max}}t(r)})})});return}o.onChange(["comboPrice","originalPrice"],function(e,n){var o=[Math.max(n.min-e.min,0),Math.max(n.max-e.max,0)].sort();var a={min:o[0].toFixed(2),max:o[1].toFixed(2)};a.str=a.min;if(a.min!=a.max){a.str+="-"+a.max}t(a)})})}});o.addAttr("canBuyStatus",{load:function(e){function t(){var e=o.get("canBuyStatus");if(e){o.set("canBuyStatus",++e)}else{o.set("canBuyStatus",1)}}o.onChange(["comboData","amount"],t);o.onLoad("product",function(e){e.onChange("canBuyStatus",t)})}})}e.extend(n,t);e.augment(n,{_cartMini:function(t,n){var o=this,a;_CTK6da3(7,"combo.run.cartMini","combo.cart.start");e.use(["dom","json"],function(e,i,r){o.onLoad(["products","master","token","buyerLoc","comboData","amount"],function(r,c,u,m,d,s){o.onMap(r,["itemData","selectedSku","amount","selectedService","itemEnable"],function(t,n,o,i,r){if(r){if(c==this){a=t}var u=[];if(i){e.each(i,function(e,t){u.push(t+"|"+(e||0))})}return{itemId:t.itemId,skuId:n?n.skuId:0,quantity:o,serviceInfo:u.join("-"),master:t.master}}else{return null}},function(r){var c=[];e.each(r,function(e){if(e){c.push(e)}});o.onTrackID(function(e){o.onLoad(["minicart"],function(r){o.onLogin(function(){r.add({anim:{img:a.pictUrl,startNode:t.button,endNode:i.get("#J_MiniCart")||i.get("#TMinaCart")||undefined},_tb_token_:u,tsid:e,add:{from_etao:o.getState("frm")=="etao"?1:"",tpId:o.get("tpId"),items:c,comboId:d.id,campaignId:d.campaignId||"",comboCnt:s,comboFrom:"",bizType:d.type,deliveryCityCode:m,deliveryZoneCode:m}},function(e){n({method:"mini",level:0,message:e.warn||"",count:e.count||e.cartQuantity,cartQuantity:e.cartQuantity||""})},function(e){n({method:"mini",level:-1,name:e.errorCode,message:e.error,count:e.count||e.cartQuantity,cartQuantity:e.cartQuantity||""})})})})})})})})},_buyForm:function(t,n){var o=this,a;_CTK6da3(7,"combo.run.buyForm","combo.run.start");e.use(["dom","json"],function(e,t,i){o.onLoad(["products","master","token","buyerLoc","comboData","amount","urlMap","shopId"],function(r,c,u,m,d,s,f,l){o.onMap(r,["itemData","selectedSku","amount","selectedService","itemEnable"],function(t,n,o,i,r){if(r){if(c==this){a=t}var u=[];if(i){e.each(i,function(e,t){u.push(t+"|"+(e||0))})}return{itemId:t.itemId,skuId:n?n.skuId:0,quantity:o,serviceInfo:u.join("-"),master:t.master}}else{return null}},function(r){var b=o._frmBid;if(!b){b=o._frmBid=t.create('<form method="post"><input type="hidden" name="combo"></form>');t.append(b,document.body)}function y(e,t){if(b[e]){b[e].value=t}else{b.innerHTML+='<input type="hidden" name="'+e+'" value="'+t+'">'}}var v=[];e.each(r,function(e){if(e){v.push(e)}});c._buylogin(function(e){e=e||{};y("combo",i.stringify({items:v,comboId:d.id,campaignId:d.campaignId||"",comboCnt:s,comboFrom:"",comboType:d.type,divisionCode:m}));y("deliveryCityCode",m);y("deliveryZoneCode",m);y("_tb_token_",u);y("bi_from","tm_comb");y("from_etao",o.getState("frm")=="etao"?1:"");if(e.success&&e.token&&e.token.length>0){var t=e.token;for(var a=0,r=t.length;a<r;a++){y(t[a][0],t[a][1])}}if(e.fastBuy){b.action=f["buyBase"]+"/fastbuy/fast_buy.htm";_CTK6da3(7,"combo.buy.fastBuy","combo.run.buyForm")}else{b.action="//buy."+(g_config.isDaily?"daily.":"")+g_config.domain+"/order/confirm_order.htm";if(g_config.domain=="yao.95095.daily.etao.net"){b.action="//buy."+g_config.domain+"/order/confirm_order.htm"}}if(e.unitPrefix&&!b.action.indexOf("http://"+e.unitPrefix+".")){b.action=(b.action||"").replace(/(http:\/\/)/,"$1"+e.unitPrefix+".");_CTK6da3(7,"combo.buy.unit","combo.run.buyForm")}b.submit();n&&n({level:0})},{itemId:a.itemId,shopId:l})})})})},buy:function(t){var n=this;t=t||{};var o;if(t.type==2){_CTK6da3(7,"combo.cart.start","model.combo.init");o=setTimeout(function(){_CTK6da3(7,"combo.cart.lose","combo.cart.start",{reject:"combo.cart.login"})},4096)}else{_CTK6da3(7,"combo.buy.start","model.combo.init");o=setTimeout(function(){_CTK6da3(7,"combo.buy.lose","combo.buy.start",{reject:"combo.buy.login"})},4096)}var n=this;function a(a){n.set("tradeResult",a.level?a:null);clearTimeout(o);var i=a.subList;n.onLoad("products",function(t){e.each(t,function(e,t){if(e.get("itemEnable")){e.set("tradeResult",a.name=="products"&&i&&i[t]&&i[t].level?i[t]:null)}})});if(t.type==2){if(a.level){_CTK6da3(7,"combo.cart.failure","combo.cart.run",{group:a.level})}else{_CTK6da3(7,"combo.cart.success","combo.cart.run")}}else{if(a.level){_CTK6da3(7,"combo.buy.failure","combo.buy.run",{group:a.level})}else{_CTK6da3(7,"combo.buy.success","combo.buy.run")}}t.callback&&t.callback(a)}n.canBuy(t,function(e){e.type=t.type||1;if(e.level>0){a(e);return}if(t.type==2){_CTK6da3(7,"combo.cart.run","combo.cart.start");n._cartMini(t,a)}else{_CTK6da3(7,"combo.buy.run","combo.cart.start");n._buyForm(t,a)}})},canSoldArea:function(t,n,o){var a=this;var t=String(t);a.onLoad(["comboData"],function(i){if(!i||!i.areaSell||!i.areas||i.areas==1){return n(true)}var r=i.areas.split(",");if(e.inArray(t,r)){return n(true)}if(/^\d\d0000$/.test(t)){return n(!!e.filter(r,function(e){return String(e).substr(0,2)==t.substr(0,2)})[0])}if(e.inArray(parseInt(t,10),[110100,120100,310100,500100,13e4,14e4,15e4,21e4,22e4,23e4,32e4,33e4,34e4,35e4,36e4,37e4,41e4,42e4,43e4,44e4,45e4,46e4,51e4,52e4,53e4,54e4,61e4,62e4,63e4,64e4,65e4,71e4,81e4,82e4,990100])){return n(false)}if(o.l2!=t){return a.canSoldArea(o.l2,n,o)}n(false)})},canBuy:function(t,n){t=t||{};t.level=t.level||0;var o=this;if(t.type==1&&g_config.bizTag&128){return n({level:8,name:"chaoshi",message:"\u5546\u8d85\u642d\u914d\u4e0d\u80fd\u7acb\u5373\u8d2d\u4e70"})}o.onLoad(["comboData","selectedProducts"],function(a,i){if(a.disabled&&a.disabledMessage){return n({level:8,name:"notCanBuy",message:a.disabledMessage||"\u6b64\u5957\u9910\u6682\u65f6\u4e0d\u80fd\u8d2d\u4e70"})}if(t.level<4&&a.type==1){if(e.keys(i).length<=1){return n({level:2,name:"itemsNotAvailable",message:"\u81f3\u5c11\u9009\u62e9\u4e00\u4e2a\u642d\u914d\u5546\u54c1\uff01"})}}o.onLoad("products",function(i){var r=0,c={},u={level:0},m={},d;e.each(i,function(e,t){if(a.type!=1||e.get("itemEnable")){r++;m[t]=e}});if(r==1&&o.get("comboData").type==1){for(var s in m){m[s].onLoad(["selectedSku","itemData"],function(e,t){var o=e?e.defaultPromType:t.defaultPromType;if(o=="comboProm"){n({level:2,name:"comboProm"});d=true}})}}if(d){return}e.each(m,function(e,o){e.set("tradeResult",null);e.canBuy(t,function(t){e.set("tradeResult",t);c[o]=t;if(u.level<t.level){u=t}if(--r===0){if(u.level>0){n({name:"products",level:u.level,subList:c,message:"\u8bf7\u91cd\u65b0\u6838\u5bf9\u60a8\u7684\u5546\u54c1\u4fe1\u606f"});return}n(u)}})})})})},getState:function(t){if(e.isArray(t)){return e.mix({},this.get("state"),undefined,t)}return(this.get("state")||{})[t]||""}});return n},{requires:["detail-model/model"]});