KISSY.add("pk/mods/core",function(a,b){function c(a){JSTracker&&JSTracker.send({msg:a.msg||"",category:a.category||"",url:"http://pk.taobao.com/track/"})}var d=document.domain.indexOf("daily.")>-1,e=d?"//pk.daily.taobao.net:8080":"//pk.taobao.com",f=e+"/json/AsyncQueryMyPetrel.do",g=e+"/json/AsyncAddPetrel.do",h=e+"/json/AsyncUpdatePetrel.do",i=e+"/index.htm";return{DIFF_URL:i,addItem:function(a){new b({url:g,data:a.data,dataType:"jsonp",type:"get",timeout:5,error:function(){c({category:"pk:addItem:error"})},complete:function(b){b&&b.success?a.success&&a.success(b):b&&b.error?a.error&&a.error(b.error):a.error&&a.error()}})},delItem:function(a){new b({url:h,data:a.data,dataType:"jsonp",type:"get",timeout:5,error:function(){c({category:"pk:delItem:error"})},complete:function(b){b&&b.success?a.success&&a.success():a.error&&a.error(b&&b.error&&b.error.errorMessage?b.error.errorMessage:"")}})},getList:function(a){new b({url:f,dataType:"jsonp",type:"get",timeout:5,error:function(){c({category:"pk:getList:error"})},complete:function(b){a.callback&&a.callback(b?b:{})}})},makePoint:function(a){var b="//gm.mmstat.com/"+a,c=document.getElementById("J_ImageDot");c||(c=new Image,c.id="J_ImageDot",c.style.display="none",document.body.appendChild(c));var d=(new Date).getTime();b=-1!=b.indexOf("?")?b+"&cache="+d:b+"?cache="+d,c.src=b},track:c}},{requires:["io","json"]}),KISSY.add("pk/mods/item",function(a,b,c,d){function e(b){a.mix(this,b),this._init()}var f=b.all;return a.augment(e,{_init:function(){this._render(),this._bindEvents()},_render:function(){var a='<em class="tb-differ-rmb">&yen;</em><em class="tb-differ-price">'+parseFloat(this.data.price).toFixed(2)+"</em>",b=this.data.invalid?"\u5df2\u5931\u6548":a,c='<li class="tb-differ-item"><div class="tb-differ-item-info"><a href="'+this.data.itemUrl+'" target="_blank" title="" class="tb-differ-item-link"><img class="tb-differ-item-img" title="" src="'+this.data.picUrl+'"/></a><a href="#" class="tb-differ-item-del"></a><div class="tb-differ-item-text">'+b+"</div></div></li>";this.itemEl=f(this.containerEl).prepend(c).first(".tb-differ-item"),this.data.invalid&&this.itemEl.addClass(".tb-differ-item-disabled .tb-differ-item-hover"),this.ischecked=!0},_bindEvents:function(){this.data.invalid||this._hover(),this.itemEl.one(".tb-differ-item-link").on("click",function(){d.makePoint("pk.1.3")})},_hover:function(){var a=this;this.itemEl.on("mouseover",function(){a.itemEl.addClass(".tb-differ-item-hover")}),this.itemEl.on("mouseout",function(){a.itemEl.removeClass(".tb-differ-item-hover")})},checked:function(a){return a+1?(this.itemEl[a?"addClass":"removeClass"]("tb-differ-item-checked"),void(this.ischecked=a)):this.ischecked},del:function(a){this._remove(a)},_remove:function(a){var b=this;this.itemEl.fadeOut(.3,function(){b.itemEl.remove(),a&&a()})}}),e},{requires:["node","event","./core"]}),KISSY.add("pk/mods/ctItem",function(a,b,c,d){var e=b.all;return{init:function(b){a.mix(this,b),a.mix(this,a.EventTarget),this.render()},render:function(){var a='<div class="tb-differ-ct-item"><div class="tb-differ-head"><div class="tb-differ-title">\u5f53\u524d\u5b9d\u8d1d</div></div><div class="tb-differ-ct-item-info"><div class="tb-differ-ct-item-img-wrapper"><a class="tb-differ-ct-item-link" target="_blank" href="'+this.itemInfo.url+'"><img class="tb-differ-ct-item-img" src="'+this.itemInfo.pic+'"/></a></div><div class="tb-differ-ct-item-rt-btn tb-differ-ct-item-add"><i class="tb-differ-ct-item-add-icon"></i><a href="#">\u52a0\u5165\u5bf9\u6bd4\u680f</a></div><div class="tb-differ-ct-item-rt-btn tb-differ-ct-item-exist"><i class="tb-differ-ct-item-add-icon"></i><a>\u5df2\u52a0\u5165\u5bf9\u6bd4\u680f</a></div></div></div>';e(this.container).append(a),this.ctItemEl=e(".tb-differ-ct-item"),this._bindEvents()},_bindEvents:function(){var a=this;this.ctItemEl.one(".tb-differ-ct-item-add").on("click",function(b){b.preventDefault(),d.makePoint("pk.1.9"),a.fire("add",{cfg:{anim:!0,trigger:b.target,callback:function(b){b.success?a.exist(!0):a._showErrorMsg(b.error?b.error.errorMessage:"\u6682\u65f6\u65e0\u6cd5\u6dfb\u52a0")}}})})},exist:function(a){return a+1?void(a?(this.ctItemEl.one(".tb-differ-ct-item-add").hide(),this.ctItemEl.one(".tb-differ-ct-item-exist").show(),this._addToList=!0):(this._removeErrorMsg(),this.ctItemEl.one(".tb-differ-ct-item-add").show(),this.ctItemEl.one(".tb-differ-ct-item-exist").hide(),this._addToList=!1)):this._addToList},_showErrorMsg:function(a){this._removeErrorMsg(),this.ctItemEl.one(".tb-differ-ct-item-info").append('<div class="tb-differ-ct-item-msg"><p class="tb-differ-ct-item-error">'+a+"</p></div>")},_removeErrorMsg:function(){var a=this.ctItemEl.one(".tb-differ-ct-item-msg");a&&this.ctItemEl.one(".tb-differ-ct-item-msg").remove()}}},{requires:["node","event","./core"]}),KISSY.add("pk/mods/itemList",function(a,b,c,d,e,f){var g=b.all,h=8,i="\u5bf9\u6bd4\u680f\u6682\u65e0\u5b9d\u8d1d\uff0c\u81f3\u5c11\u52a0\u5165\u4e24\u4ef6\u5b9d\u8d1d\u624d\u80fd\u8fdb\u884c\u5bf9\u6bd4\uff01",j="\u52a0\u8f7d\u5931\u8d25\uff0c\u8bf7\u7a0d\u540e\u91cd\u8bd5";return{init:function(b){this.items={},this.num=0,a.mix(this,b),a.mix(this,a.EventTarget),this.render()},render:function(){var a=this;a.num=0,a._rendered=!0,a.listBox&&a.listBox.empty();var b='<div class="tb-differ-item-list-box"><div class="tb-differ-head"><h3 class="tb-differ-title">\u5b9d\u8d1d\u5bf9\u6bd4<span class="tb-differ-desc">(\u5df2\u6dfb\u52a0<em class="tb-differ-num">0</em>/<em>'+h+'</em>)</span></h3></div><div class="tb-differ-body"><ul class="tb-differ-item-list"></ul><div class="tb-differ-btns"><a href="#" class="tb-differ-clear">\u6e05\u7a7a</a><a href="#" class="tb-differ-start">\u5f00\u59cb\u5bf9\u6bd4</a></div></div></div>';g(a.container).append(b),this.listBox=g(".tb-differ-item-list-box"),this.totalNumEl=this.listBox.one(".tb-differ-num"),this.listBody=this.listBox.one(".tb-differ-body"),this.listContainer=this.listBox.one(".tb-differ-item-list"),this.diffEl=this.listBox.one(".tb-differ-start"),this._resetHeight(),this._bindEvents()},renderErrorMsg:function(a){a=a?a:i,this.listBox.one(".tb-differ-msg")&&this.listBox.one(".tb-differ-msg").remove(),this.listBox.addClass(".tb-differ-item-list-box-no-bg"),this.listBody&&this.listBody.hide(),g(".tb-differ-confirm")&&g(".tb-differ-confirm").remove();var b='<div class="tb-differ-msg">'+a+"</div>";this.listBox.append(b)},renderList:function(a){var b=this;b.listContainer.empty(),b.num=0,b.items={},b._updateNum(),a?a.length<=0?b.renderErrorMsg(i):b.renderItems(a):b.renderErrorMsg(j)},renderItems:function(b){var c=this;c._rendered&&(0==this.num&&(this.listBox.one(".tb-differ-msg")&&(this.listBox.one(".tb-differ-msg").remove(),this.listBox.removeClass(".tb-differ-item-list-box-no-bg")),this.listBody.show()),b.reverse(),a.each(b,function(a){c.items[a.id]=new f({containerEl:c.listContainer,data:a}),c._bindItemEvents(c.items[a.id]),c.num++}),c._updateNum(),c._resetListHeight())},_bindEvents:function(){var a=this;this.listBox.one(".tb-differ-clear").on("click",function(b){b.preventDefault(),a._confirm(b.target,"\u786e\u5b9a\u6e05\u7a7a\u6240\u6709\u5546\u54c1?",function(){e.makePoint("pk.1.7"),a._clear()})}),this.listBox.one(".tb-differ-start").on("click",function(b){b.preventDefault(),e.makePoint("pk.1.6"),a._pk()}),d.on(window,"resize",function(){a._resetHeight(),a._resetListHeight()})},_resetHeight:function(){if(this.listContainer){var a=this.showCtItem?c.viewportHeight()-300:c.viewportHeight()-40;this.listBox.css("height",Math.max(a+5,140)),this.listBody.css("height",Math.max(a-40,100))}},_resetListHeight:function(){var b=this.listBody.outerHeight();this.listContainer.css("height","auto");var c=60;(7==a.UA.ie||6==a.UA.ie)&&(c=120),b<this.listContainer.outerHeight()+c?this.listContainer.css("height",Math.max(b-c,82)):this.listContainer.css("height","auto")},_bindItemEvents:function(a){var b=this;a.itemEl.one(".tb-differ-item-del").on("click",function(c){c.halt(),b._delItem(a),e.makePoint("pk.1.5")})},_delItem:function(a){var b=this;e.delItem({data:{ids:a.data.id,opType:2}}),a.del(function(){b._resetListHeight()}),b.items[a.data.id]=null,b.num--,b._updateNum(),b.fire("del-item",{itemId:a.data.itemId})},_clear:function(){var b=this,c=[];a.each(b.items,function(a){a&&a.data&&c.push(a.data.id)}),e.delItem({data:{ids:c.join(","),opType:2}}),b.listContainer.empty(),b.num=0,b.items={},b._updateNum(),b.fire("clear-item"),b._resetListHeight()},_pk:function(){var b=this._getValidIds(),c=this._getValidItemIds();return 1==b.length&&this.ctItemId&&a.inArray(this.ctItemId+"",c)||b.length<=0?void this._addCountError():void this.fire("start-pk",{items:b})},_updateNum:function(){this.totalNumEl.html(this.num),this.num<=0?this.renderErrorMsg(i):this._checkCount()},_getValidIds:function(){var b=this,c=[];return a.each(b.items,function(a){a&&a.data&&!a.data.invalid&&c.push(a.data.id+"")}),c},_getValidItemIds:function(){var b=this,c=[];return a.each(b.items,function(a){a&&a.data&&!a.data.invalid&&c.push(a.data.itemId+"")}),c},_checkCount:function(){var b=this,c=b._getValidIds(),d=this._getValidItemIds(),e=c.length;return 0>=e?this.diffEl.addClass(".tb-differ-disable"):1==e?b.ctItemId&&a.inArray(b.ctItemId+"",d)?this.diffEl.addClass(".tb-differ-disable"):(this.diffEl.removeClass(".tb-differ-disable"),this._clearCountError()):(this.diffEl.removeClass(".tb-differ-disable"),2==e&&this._clearCountError()),c},_addCountError:function(){this._clearCountError();var a='<div class="tb-differ-warn">\u8bf7\u81f3\u5c11\u9009\u62e9\u4e24\u4e2a\u5546\u54c1\uff01</div>';this.container.one(".tb-differ-btns").append(a)},_clearCountError:function(){var a=this.container.one(".tb-differ-btns").one(".tb-differ-warn");a&&a.remove()},_confirm:function(a,b,d){var e='<div class="tb-differ-confirm"><div class="tb-differ-confirm-box"><p class="tb-differ-confirm-msg">'+b+'</p><a class="tb-differ-confirm-ok" href="#">\u786e\u5b9a</a><a class="tb-differ-confirm-cancel" href="#">\u53d6\u6d88</a></div><i class="tb-differ-confirm-bottom"></i></div>',f=c.create(e);this.container.append(f),f=g(f),f.css({right:35,bottom:63}),f.one(".tb-differ-confirm-ok").on("click",function(a){a.halt(),f.remove(),d()}),f.one(".tb-differ-confirm-cancel").on("click",function(a){a.halt(),f.remove()})}}},{requires:["node","dom","event","./core","./item"]}),KISSY.add("pk/index",function(a,b,c,d,e,f,g,h,i,j){var k=a.mix({_inited:!1,_rendered:!1},a.EventTarget),l=b.all;return a.mix(k,{init:function(b){this.items={},this.trigger=l(b.trigger),this.wrapper=l(b.wrapper),this.reload=b.reload?b.reload:!0,b.ctItem&&!a.isEmptyObject(b.ctItem)&&(this._showCtItem=!0,this.ctItem=b.ctItem),this.makePoint=h.makePoint},show:function(){var a=this;a._rendered||a._render(),this.reload?a._load():a._inited||a._load()},_load:function(){var a=this;a._loading||(a._loading=!0,h.getList({callback:function(b){a._renderItemList(b),b.success&&(a._inited=!0),a._loading=!1}}))},_render:function(){var a=this;this.container&&this.container.remove();var b='<div class="tb-differ-box tb-J_differBox"><a class="tb-differ-fold" href="#" target="_blank">\u6536\u8d77</a><a class="tb-differ-go" target="_blank"></a></div>';l(this.wrapper).append(b),this.container=l(".tb-J_differBox"),this.container.one(".tb-differ-fold").on("click",function(b){b.halt(),a.fire("hide")}),a._showCtItem&&a._initCtItem(),a._initItemList(),a._showCtItem&&a._initCtListener(),a._rendered=!0},_initItemList:function(){var a=this;j.init({container:this.container,showCtItem:this._showCtItem,ctItemId:a.ctItem?a.ctItem.itemId:""}),j.on("start-pk",function(b){a.diff(b.items)})},_initCtItem:function(){i.init({container:this.container,itemInfo:this.ctItem})},_initCtListener:function(){var b=this;i.on("add",function(c){var d=a.mix(c.cfg,b.ctItem);b.addItem(d)}),j.on("del-item",function(a){i.itemInfo.itemId==a.itemId?i.exist(!1):7==j.num&&i._removeErrorMsg()}),j.on("clear-item",function(){i.exist(!1)})},_renderItemList:function(b){var c=this;if(!b||!b.success)return void j.renderErrorMsg(b.error?b.error.errorMessage:"");if(j.renderList(b.list),b.list&&c.ctItem){var d=!1;a.each(b.list,function(a){a.itemId==c.ctItem.itemId&&(d=!0)}),i.exist(d)}},addItem:function(a){var b=this,c={cartId:a.cartId?a.cartId:0,itemId:a.itemId,skuId:a.skuId?a.skuId:0,from:a.from?a.from:2,price:a.price};h.addItem({data:c,success:function(c){a.anim&&a.trigger?b._fly(a.trigger,a.pic,function(){j.renderItems(c.list)}):j.renderItems(c.list),i.itemInfo&&i.itemInfo.itemId==c.list[0].itemId&&i.exist(!0),a.callback&&a.callback({success:!0})},error:function(b){a.callback&&a.callback({success:!1,error:b})}})},diff:function(a){var b=this,c=h.DIFF_URL+"?ids="+a.join(",");b._showCtItem&&!i.exist()&&(c=c+"&items="+i.itemInfo.itemId,i.itemInfo.skuId&&(c=c+"_"+i.itemInfo.skuId)),l(".tb-differ-go").attr("href",c).fire("click")},_isShown:function(){return"none"!=this.wrapper.css("display")&&this._rendered},_fly:function(a,b,d){var e,g,h=this;h._isShown()?(g=this.container.one(".tb-differ-item-list-box").offset(),e={left:g.left,top:g.top+80}):(g=l(h.trigger).offset(),e={left:g.left-40,top:g.top});var i="<div class='tb-differ-item-miniature'><img src='"+b+"'/></div>",j=c.create(i);l("body").append(j);var k=l(a).offset();l(j).css(k);var m=.7,n=Math.ceil((e.top-k.top)/100);1===n?m=.3:2===n?m=.4:3===n?m=.5:4===n&&(m=.6);var o=f(j,e,m,null,function(){l(j).remove(),d()});o.run()}}),k},{requires:["node","dom","event","io","anim","./mods/item","./mods/core","./mods/ctItem","./mods/itemList"]});